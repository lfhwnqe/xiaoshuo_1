# 运维与部署（Ops & Deploy）

## 运行形态

- 本地模式：CLI/Node 脚本直接启动工作流，适合单人迭代。
- 服务模式：Hono HTTP 服务 + `@mastra/deployer/server`，对外暴露工作流启动/查看状态接口。

## 配置与密钥

- `.env`：模型密钥、向量库密钥、日志级别等。
- `config/`：风格模板/系统提示/阈值参数统一配置，区分 `dev`/`prod`。

## 监控与日志

- 关键指标：
  - 运行成功率、平均修订轮数、平均章节耗时
  - 召回命中率、风格一致性评分、一致性纠偏次数
- 日志采集：Pino 输出 JSON，可对接 ELK/Datadog（后续）。

## 备份与回滚

- `data/` 与 `outputs/` 定期打包；重要版本（蓝图/终稿）标记版本号。
- 回滚策略：
  - 蓝图回滚：回退 `blueprint.history.jsonl` 指定版本并重算章节。
  - 单章回滚：选取终稿快照，触发“修订回路”生成新版本。

## 安全与配额

- 配额限制：为模型调用设置全局节流与单步最大 token；
- 输入脱敏：如接入外部资料，需对隐私字段做掩码。

## 部署建议

- Serverless：Vercel/Netlify（需注意运行时超时，长任务用异步+回调/轮询）。
- 容器化：Docker + 定时任务（多章节批量生成更高效）。

